using Pkg
Pkg.activate(@__DIR__)

using HTTP, JSON3, Dates

const BASE_URL = "https://lfps.usgs.gov/api"
const HEADER = Dict("Accept" => "application/json", "Content-Type" => "application/json")

function get_latest_products()
    url = "$BASE_URL/products"
    response = HTTP.get(url, HEADER)
    obj = JSON3.read(response.body)
    prods = map(obj.products) do x
        (name=x.productName, theme=x.theme, layer=x.layerName, version=x.version, conus=x.conus, ak=x.ak, hi=x.hi, geoAreas=x.geoAreas)
    end
    sort!(prods, by = p -> p.name)
end

# Replace src/products.jl with updated product list
function generate_products_file!!()
    file = joinpath(@__DIR__, "..", "src", "products.jl")
    open(file, "w") do io
        println(io, "# This file is autogenerated. Do not edit manually.")
        println(io, "# Generated at ", Dates.now())
        println(io, "PRODUCTS::Vector{Product} = [")
        for p in get_latest_products()
            print(io, "    Product(")
            join(io, [repr(getproperty(p,k)) for k in propertynames(p)], ", ")
            println(io, "),")
        end
        println(io, "]")
    end
end

generate_products_file!!()
